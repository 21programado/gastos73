<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Gastos Mensuales</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .mes-navegacion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .mes-actual {
            font-size: 18px;
            font-weight: bold;
        }
        
        .total-mes {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: bold;
        }
        
        .lista-gastos {
            display: grid;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .gasto-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .gasto-item.pagado {
            border-left-color: #27ae60;
            opacity: 0.8;
        }
        
        .gasto-info h3 {
            margin-bottom: 5px;
        }
        
        .gasto-monto {
            font-size: 18px;
            font-weight: bold;
        }
        
        .gasto-acciones {
            display: flex;
            gap: 5px;
        }
        
        .btn-editar, .btn-eliminar {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .btn-editar { background: #f39c12; }
        .btn-eliminar { background: #e74c3c; }
        
        .formulario-gasto {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .campos-cuotas {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .btn-submit {
            background: #2c3e50;
            width: 100%;
            padding: 12px;
            font-size: 18px;
        }
        
        .oculto {
            display: none;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .gasto-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .gasto-acciones {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ðŸ“Š Control de Gastos Mensuales</h1>
    </header>
    
    <div class="mes-navegacion">
        <button class="btn" id="btnAnterior">â—€ Mes Anterior</button>
        <div class="mes-actual" id="mesActual">Enero 2024</div>
        <button class="btn" id="btnSiguiente">Mes Siguiente â–¶</button>
    </div>
    
    <div class="total-mes" id="totalMes">Total: $0.00</div>
    
    <div class="lista-gastos" id="listaGastos">
        <!-- Los gastos se cargarÃ¡n aquÃ­ -->
    </div>
    
    <div class="formulario-gasto" id="formularioGasto">
        <h2>Agregar Nuevo Gasto</h2>
        <form id="formGasto">
            <div class="form-group">
                <label for="descripcion">DescripciÃ³n *</label>
                <input type="text" id="descripcion" required>
            </div>
            
            <div class="form-group">
                <label for="monto">Monto (opcional, default 0)</label>
                <input type="number" id="monto" min="0" step="0.01">
            </div>
            
            <div class="form-group">
                <label for="tipo">Tipo *</label>
                <select id="tipo" required>
                    <option value="Fijo">Fijo (todos los meses)</option>
                    <option value="Cuotas">Cuotas</option>
                </select>
            </div>
            
            <div class="campos-cuotas" id="camposCuotas">
                <div class="form-group">
                    <label for="cuotas">Total de Cuotas</label>
                    <input type="number" id="cuotas" min="2" value="2">
                </div>
            </div>
            
            <div class="form-group">
                <label for="mes_inicio">Mes de Inicio *</label>
                <input type="month" id="mes_inicio" required>
            </div>
            
            <div class="campos-cuotas" id="campoMesFin">
                <div class="form-group">
                    <label for="mes_fin">Mes de Fin (solo cuotas)</label>
                    <input type="month" id="mes_fin">
                </div>
            </div>
            
            <div class="form-group">
                <label for="estado">Estado</label>
                <select id="estado">
                    <option value="Pendiente">Pendiente</option>
                    <option value="Pagado">Pagado</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-submit">ðŸ’¾ Guardar Gasto</button>
            <button type="button" class="btn" id="btnCancelar" style="margin-top: 10px; background: #95a5a6;">Cancelar</button>
        </form>
    </div>
    
    <script>
        // CONFIGURACIÃ“N
        const API_URL = 'https://script.google.com/macros/s/AKfycbyxZYiJG0EooZcx_kYc5zavzOZBL7evm18uAMdlUKnyY2gGAbNsTGWsCLqqvojVG88I/exec'; // <-- PON TU URL AQUÃ
        
        // Estado de la aplicaciÃ³n
        let mesActual = new Date().getFullYear() + '-' + 
                       String(new Date().getMonth() + 1).padStart(2, '0');
        let editandoId = null;
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            configurarEventos();
            cargarMes(mesActual);
            configurarFechaInicio();
        });
        
        function configurarEventos() {
            // NavegaciÃ³n por meses
            document.getElementById('btnAnterior').addEventListener('click', () => cambiarMes(-1));
            document.getElementById('btnSiguiente').addEventListener('click', () => cambiarMes(1));
            
            // Mostrar/ocultar campos de cuotas
            document.getElementById('tipo').addEventListener('change', function() {
                const mostrarCuotas = this.value === 'Cuotas';
                document.getElementById('camposCuotas').style.display = mostrarCuotas ? 'block' : 'none';
                document.getElementById('campoMesFin').style.display = mostrarCuotas ? 'block' : 'none';
                
                if (mostrarCuotas) {
                    calcularMesFin();
                }
            });
            
            // Calcular mes fin cuando cambia cuotas o mes inicio
            document.getElementById('cuotas').addEventListener('change', calcularMesFin);
            document.getElementById('mes_inicio').addEventListener('change', calcularMesFin);
            
            // Formulario
            document.getElementById('formGasto').addEventListener('submit', guardarGasto);
            document.getElementById('btnCancelar').addEventListener('click', resetForm);
        }
        
        function configurarFechaInicio() {
            const hoy = new Date();
            const mesFormato = hoy.getFullYear() + '-' + 
                              String(hoy.getMonth() + 1).padStart(2, '0');
            document.getElementById('mes_inicio').value = mesFormato;
        }
        
        function calcularMesFin() {
            if (document.getElementById('tipo').value !== 'Cuotas') return;
            
            const mesInicio = document.getElementById('mes_inicio').value;
            const cuotas = parseInt(document.getElementById('cuotas').value) || 2;
            
            if (mesInicio) {
                const [anio, mes] = mesInicio.split('-').map(Number);
                let mesFin = mes + cuotas - 1;
                let anioFin = anio;
                
                while (mesFin > 12) {
                    mesFin -= 12;
                    anioFin += 1;
                }
                
                const mesFinStr = anioFin + '-' + String(mesFin).padStart(2, '0');
                document.getElementById('mes_fin').value = mesFinStr;
            }
        }
        
        function cambiarMes(direccion) {
            const [anio, mes] = mesActual.split('-').map(Number);
            let nuevoMes = mes + direccion;
            let nuevoAnio = anio;
            
            if (nuevoMes > 12) {
                nuevoMes = 1;
                nuevoAnio += 1;
            } else if (nuevoMes < 1) {
                nuevoMes = 12;
                nuevoAnio -= 1;
            }
            
            mesActual = nuevoAnio + '-' + String(nuevoMes).padStart(2, '0');
            cargarMes(mesActual);
        }
        
        async function cargarMes(mes) {
            try {
                // Actualizar display del mes
                const fecha = new Date(mes + '-01');
                const nombreMes = fecha.toLocaleDateString('es-ES', { 
                    month: 'long', 
                    year: 'numeric' 
                }).replace(/^\w/, c => c.toUpperCase());
                
                document.getElementById('mesActual').textContent = nombreMes;
                
                // Cargar gastos desde la API
                const respuesta = await fetch(`${API_URL}?accion=obtener_mes&mes=${mes}`);
                const datos = await respuesta.json();
                
                mostrarGastos(datos.gastos, datos.total);
            } catch (error) {
                console.error('Error al cargar mes:', error);
                alert('Error al cargar los gastos');
            }
        }
        
        function mostrarGastos(gastos, total) {
            const lista = document.getElementById('listaGastos');
            const totalElement = document.getElementById('totalMes');
            
            // Actualizar total
            totalElement.textContent = `Total: $${total.toFixed(2)}`;
            
            // Mostrar gastos
            if (gastos.length === 0) {
                lista.innerHTML = '<div class="gasto-item">No hay gastos este mes</div>';
                return;
            }
            
            lista.innerHTML = gastos.map(gasto => `
                <div class="gasto-item ${gasto.estado === 'Pagado' ? 'pagado' : ''}" data-id="${gasto.id}">
                    <div class="gasto-info">
                        <h3>${gasto.descripcion}</h3>
                        <div>
                            ${gasto.tipo === 'Cuotas' ? 
                              `Cuota ${gasto.mes_inicio.split('-')[1]}/${gasto.cuotas} â€¢ ` : ''}
                            ${gasto.estado}
                        </div>
                    </div>
                    <div class="gasto-monto">$${parseFloat(gasto.monto).toFixed(2)}</div>
                    <div class="gasto-acciones">
                        <button class="btn btn-editar" onclick="editarGasto(${gasto.id})">Editar</button>
                        <button class="btn btn-eliminar" onclick="eliminarGasto(${gasto.id})">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function guardarGasto(e) {
            e.preventDefault();
            
            const formData = {
                descripcion: document.getElementById('descripcion').value,
                monto: parseFloat(document.getElementById('monto').value) || 0,
                tipo: document.getElementById('tipo').value,
                cuotas: parseInt(document.getElementById('cuotas').value) || 1,
                mes_inicio: document.getElementById('mes_inicio').value,
                estado: document.getElementById('estado').value
            };
            
            // Solo agregar mes_fin si es cuotas
            if (formData.tipo === 'Cuotas') {
                formData.mes_fin = document.getElementById('mes_fin').value;
            }
            
            try {
                const accion = editandoId ? 'editar' : 'agregar';
                const url = API_URL;
                
                if (editandoId) {
                    formData.id = editandoId;
                }
                
                const respuesta = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify({
                        accion: accion,
                        ...formData
                    })
                });
                
                const resultado = await respuesta.json();
                
                if (resultado.error) {
                    throw new Error(resultado.error);
                }
                
                alert(editandoId ? 'Gasto actualizado' : 'Gasto agregado');
                resetForm();
                cargarMes(mesActual);
                
            } catch (error) {
                console.error('Error al guardar:', error);
                alert('Error: ' + error.message);
            }
        }
        
        function editarGasto(id) {
            const elemento = document.querySelector(`[data-id="${id}"]`);
            if (!elemento) return;
            
            // Buscar el gasto en la lista actual
            const gastos = document.querySelectorAll('.gasto-item');
            let gastoData = null;
            
            gastos.forEach(gasto => {
                if (parseInt(gasto.dataset.id) === id) {
                    const descripcion = gasto.querySelector('h3').textContent;
                    const monto = gasto.querySelector('.gasto-monto').textContent.replace('$', '');
                    
                    gastoData = {
                        id: id,
                        descripcion: descripcion,
                        monto: parseFloat(monto)
                    };
                }
            });
            
            if (gastoData) {
                editandoId = id;
                document.getElementById('descripcion').value = gastoData.descripcion;
                document.getElementById('monto').value = gastoData.monto;
                
                // Scroll al formulario
                document.getElementById('formularioGasto').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        async function eliminarGasto(id) {
            if (!confirm('Â¿Eliminar este gasto?')) return;
            
            try {
                const respuesta = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        accion: 'eliminar',
                        id: id
                    })
                });
                
                const resultado = await respuesta.json();
                
                if (resultado.error) {
                    throw new Error(resultado.error);
                }
                
                alert('Gasto eliminado');
                cargarMes(mesActual);
                
            } catch (error) {
                console.error('Error al eliminar:', error);
                alert('Error: ' + error.message);
            }
        }
        
        function resetForm() {
            document.getElementById('formGasto').reset();
            editandoId = null;
            configurarFechaInicio();
            document.getElementById('camposCuotas').style.display = 'none';
            document.getElementById('campoMesFin').style.display = 'none';
        }
    </script>
</body>
</html>